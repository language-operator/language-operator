#!/usr/bin/env bash

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_step() {
    echo -e "${BLUE}==>${NC} ${1}"
}

print_success() {
    echo -e "${GREEN}✓${NC} ${1}"
}

print_error() {
    echo -e "${RED}✗${NC} ${1}"
}

print_warning() {
    echo -e "${YELLOW}!${NC} ${1}"
}

# Get the script directory and project root
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "${SCRIPT_DIR}/.." && pwd )"

cd "${PROJECT_ROOT}"

echo "Building all based images..."
echo ""

# Build order based on dependencies:
# 1. base (foundation)
# 2. devel and tools (depend on base)
# 3. tool services (depend on tools)

# Helper function to build an image
build_image() {
    local tag="$1"
    local context="$2"

    print_step "Building ${tag}"
    if docker build -t "${tag}" "${context}"; then
        print_success "${tag} built successfully"
    else
        print_error "Failed to build ${tag}"
        exit 1
    fi
    echo ""
}

# Build components in fixed order
COMPONENTS_ORDER=("base" "devel" "server" "client")
for component in "${COMPONENTS_ORDER[@]}"; do
    build_image "based/${component}:latest" "components/${component}/"
done

# Build all tool services by globbing the tools directory
for tool_dir in tools/*/; do
    if [ -d "$tool_dir" ] && [ -f "${tool_dir}Dockerfile" ]; then
        tool_name=$(basename "$tool_dir")
        build_image "based/tools/${tool_name}:latest" "$tool_dir"
    fi
done

# Build agent services (depend on based/client)
AGENTS_ORDER=("cli" "web" "headless")
for agent in "${AGENTS_ORDER[@]}"; do
    build_image "based/agent-${agent}:latest" "agents/${agent}/"
done

# Summary
echo ""
print_success "All images built successfully!"
echo ""
echo "Built images:"

# List component images
for component in "${COMPONENTS_ORDER[@]}"; do
    echo "  - based/${component}:latest"
done

# List tool images
for tool_dir in tools/*/; do
    if [ -d "$tool_dir" ] && [ -f "${tool_dir}Dockerfile" ]; then
        tool_name=$(basename "$tool_dir")
        echo "  - based/tools/${tool_name}:latest"
    fi
done

# List agent images
for agent in "${AGENTS_ORDER[@]}"; do
    echo "  - based/agent-${agent}:latest"
done
