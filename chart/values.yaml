# Default values for language-operator.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: ghcr.io/language-operator/language-operator
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ServiceAccount configuration
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# Pod annotations
podAnnotations: {}

# Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

# Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65532

# Service configuration
service:
  type: ClusterIP
  port: 8080
  metricsPort: 8443
  annotations: {}

# Resource limits and requests
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Liveness probe configuration
livenessProbe:
  httpGet:
    path: /healthz
    port: 8081
  initialDelaySeconds: 15
  periodSeconds: 20

# Readiness probe configuration
readinessProbe:
  httpGet:
    path: /readyz
    port: 8081
  initialDelaySeconds: 5
  periodSeconds: 10

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity and anti-affinity rules
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - language-operator
        topologyKey: kubernetes.io/hostname

# Pod disruption budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1
  # maxUnavailable: 1

# Horizontal Pod Autoscaler
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Operator configuration
config:
  # Leader election configuration
  leaderElection:
    enabled: true
    leaseDuration: 15s
    renewDeadline: 10s
    retryPeriod: 2s

  # Metrics configuration
  metrics:
    bindAddress: ":8443"
    secure: true

  # Health probe configuration
  health:
    bindAddress: ":8081"

  # Webhook configuration
  webhook:
    enabled: true
    port: 9443
    certDir: /tmp/k8s-webhook-server/serving-certs

  # Logging configuration
  logging:
    level: info
    format: json
    development: false

  # Controller configuration
  controller:
    # Number of concurrent reconcilers per controller
    concurrency: 5
    # Sync period for controller
    syncPeriod: 10m

  # Self-healing synthesis configuration
  selfHealing:
    # Enable self-healing synthesis for failed agents
    enabled: true
    # Maximum self-healing attempts before marking agent as failed
    maxAttempts: 5
    # Minimum backoff between self-healing attempts
    minBackoff: 1m
    # Maximum backoff between self-healing attempts
    maxBackoff: 16m
    # Number of consecutive failures required to trigger self-healing
    failureThreshold: 2
    # Sanitize logs before passing to LLM (redact secrets)
    sanitizeLogs: true
    # Maximum log lines to extract from crashed containers
    maxLogLines: 100
    # Timeout for log extraction
    logFetchTimeout: 5s

  # Agent runtime security configuration
  # These settings apply to LanguageAgent pods created by the operator
  agentSecurity:
    # Pod security context for agent containers
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000  # langop user (matches agent Dockerfile)
      fsGroup: 101     # langop group
      seccompProfile:
        type: RuntimeDefault

    # Container security context for agent containers
    containerSecurityContext:
      allowPrivilegeEscalation: false
      runAsNonRoot: true
      runAsUser: 1000  # langop user (matches agent Dockerfile)
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL

    # Enable tmpfs volumes for read-only filesystem compatibility
    # These volumes allow writes to specific directories while keeping root filesystem read-only
    tmpfsVolumes:
      enabled: true
      # Use memory-backed tmpfs (fast but uses pod memory limit)
      useMemory: true
      volumes:
        # General temporary directory
        - name: tmp
          mountPath: /tmp
        # Ruby bundler cache
        - name: ruby-bundle
          mountPath: /home/langop/.bundle
        # Ruby gem installation directory
        - name: ruby-gem
          mountPath: /home/langop/.gem

  # Watch configuration
  watch:
    # Namespaces to watch (empty means all namespaces)
    namespaces: []

# RBAC configuration
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Rules for the operator's ClusterRole
  rules:
    # Core Kubernetes resources
    - apiGroups:
      - ""
      resources:
      - configmaps
      - secrets
      - services
      - serviceaccounts
      - pods
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - ""
      resources:
      - events
      verbs:
      - create
      - patch
      - list
      - watch
    # Coordination resources for leader election
    - apiGroups:
      - coordination.k8s.io
      resources:
      - leases
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Apps resources
    - apiGroups:
      - apps
      resources:
      - deployments
      - replicasets
      - statefulsets
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - apps
      resources:
      - daemonsets
      verbs:
      - get
      - list
      - watch
    # Networking resources
    - apiGroups:
      - networking.k8s.io
      resources:
      - ingresses
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Gateway API resources
    - apiGroups:
      - gateway.networking.k8s.io
      resources:
      - httproutes
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - gateway.networking.k8s.io
      resources:
      - referencegrants
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Policy resources
    - apiGroups:
      - policy
      resources:
      - poddisruptionbudgets
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Autoscaling resources
    - apiGroups:
      - autoscaling
      resources:
      - horizontalpodautoscalers
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Batch resources (for scheduled agents)
    - apiGroups:
      - batch
      resources:
      - jobs
      - cronjobs
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Language Operator CRDs
    - apiGroups:
      - langop.io
      resources:
      - languagetools
      - languagemodels
      - languageagents
      - languagepersonas
      - languageclients
      - languageclusters
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    - apiGroups:
      - langop.io
      resources:
      - languagetools/status
      - languagemodels/status
      - languageagents/status
      - languagepersonas/status
      - languageclients/status
      - languageclusters/status
      verbs:
      - get
      - update
      - patch
    - apiGroups:
      - langop.io
      resources:
      - languagetools/finalizers
      - languagemodels/finalizers
      - languageagents/finalizers
      - languagepersonas/finalizers
      - languageclients/finalizers
      - languageclusters/finalizers
      verbs:
      - update
    # Networking resources for LanguageCluster
    - apiGroups:
      - networking.k8s.io
      resources:
      - networkpolicies
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # PersistentVolumeClaims for agent workspaces
    - apiGroups:
      - ""
      resources:
      - persistentvolumeclaims
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # Namespace management for LanguageCluster
    - apiGroups:
      - ""
      resources:
      - namespaces
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete
    # RBAC resources for LanguageCluster
    - apiGroups:
      - rbac.authorization.k8s.io
      resources:
      - roles
      - rolebindings
      verbs:
      - get
      - list
      - watch
      - create
      - update
      - patch
      - delete

# Monitoring configuration
monitoring:
  # Prometheus ServiceMonitor
  serviceMonitor:
    enabled: false
    # Namespace where ServiceMonitor will be created (defaults to release namespace)
    namespace: ""
    # Additional labels for ServiceMonitor
    labels: {}
    # Interval at which metrics should be scraped
    interval: 30s
    # Timeout for scraping
    scrapeTimeout: 10s

# OpenTelemetry configuration
# Enables distributed tracing for operator and agents
# OpenTelemetry Configuration
# Split into two distinct purposes for clarity:

# 1. DATA COLLECTION - Where agents/tools/operator send telemetry data
opentelemetry:
  collector:
    # Enable OpenTelemetry data collection (default: false for opt-in behavior)
    enabled: false

    # OTLP gRPC endpoint for exporting traces/metrics/logs
    # This is where all operator components send their telemetry data
    # Examples:
    #   - "otel-collector.observability.svc.cluster.local:4317" (in-cluster collector)
    #   - "otel-collector:4317" (same namespace)
    #   - "jaeger-collector.observability.svc.cluster.local:4317" (Jaeger with OTLP)
    endpoint: ""

    # Sampling configuration for data collection
    sampling:
      # Trace sampling rate (0.0 to 1.0)
      # 1.0 = sample 100% of traces (recommended for development)
      # 0.1 = sample 10% of traces (recommended for production)
      # 0.01 = sample 1% of traces (high-volume production)
      rate: 1.0

    # Resource attributes for trace identification
    # These attributes help identify and filter traces in your observability platform
    resourceAttributes:
      # Environment identifier (e.g., production, staging, development)
      environment: "production"

      # Kubernetes cluster name (helps when aggregating traces from multiple clusters)
      cluster: "main"

      # Custom resource attributes (key-value pairs)
      # Example:
      #   region: "us-east-1"
      #   team: "platform"
      #   cost_center: "engineering"
      custom: {}

# 2. DATA QUERYING - Where the learning system queries historical telemetry data
telemetry:
  queryBackend:
    # Enable telemetry query backend for learning system (default: false for opt-in behavior)
    enabled: false

    # Backend type: "signoz", "jaeger", "tempo", or "noop"
    type: "signoz"

    # Query endpoint for historical data retrieval
    # This is where the learning system queries traces for pattern analysis
    endpoint: ""
    # Example endpoints:
    #   SigNoz: "https://signoz.example.com" 
    #   Jaeger: "https://jaeger.example.com"
    #   Tempo: "https://tempo.example.com"

    # Authentication for query backend
    auth:
      # API key for authentication (for SigNoz, Grafana Cloud, etc.)
      # Can be provided directly or via secret reference
      apiKey: ""
      
      # Secret reference for API key (recommended for production)
      # Example:
      #   secretName: "signoz-credentials"
      #   secretKey: "api-key"
      apiKeySecret:
        name: ""
        key: ""

      # Additional auth headers (optional)
      # Example for custom auth schemes:
      #   Authorization: "Bearer token"
      #   X-Custom-Auth: "value"
      headers: {}

    # Connection settings
    timeout: "30s"
    retryAttempts: 3
    retryBackoff: "1s"

    # Query configuration
    query:
      # Maximum number of traces to query per request
      maxTraces: 100
      
      # Time range for historical queries
      lookbackPeriod: "24h"
      
      # Query timeout for individual requests  
      timeout: "10s"

    # Health check configuration
    healthCheck:
      # Enable periodic health checks
      enabled: true
      
      # Health check interval
      interval: "5m"
      
      # Health check timeout
      timeout: "10s"

# Agent-specific data collection configuration
# Allows agents and tools to use different collection settings than the operator
agentTelemetry:
  # OTLP endpoint override for agents and tools
  # If empty, agents inherit the operator's opentelemetry.collector.endpoint
  # Useful for routing agent traces to a different collector
  # Example: "otel-collector-agents.observability.svc.cluster.local:4317"
  endpoint: ""

  # Sampling rate override for agents and tools
  # If null, agents inherit the operator's opentelemetry.collector.sampling.rate
  # Set to a lower rate (e.g., 0.1) to reduce agent trace volume
  # while keeping operator traces at 100% sampling
  samplingRate: null

# CRD installation
crds:
  # Install CRDs as part of the Helm chart
  install: true
  # Keep CRDs on chart uninstall
  keep: true
  # Annotations to add to CRDs
  annotations: {}

# Additional volumes
volumes: []
# - name: tmp
#   emptyDir: {}

# Additional volume mounts
volumeMounts: []
# - name: tmp
#   mountPath: /tmp

# Extra environment variables
# Note: Synthesis is now configured per-agent via ModelRefs in LanguageAgent CRDs
env:
  - name: SELF_HEALING_ENABLED
    value: "{{ .Values.config.selfHealing.enabled }}"
  - name: SELF_HEALING_MAX_ATTEMPTS
    value: "{{ .Values.config.selfHealing.maxAttempts }}"
  - name: SELF_HEALING_FAILURE_THRESHOLD
    value: "{{ .Values.config.selfHealing.failureThreshold }}"

# Extra environment variables from ConfigMap or Secret
envFrom: []
# - configMapRef:
#     name: my-config
# - secretRef:
#     name: my-secret

# Priority class name
priorityClassName: ""

# Topology spread constraints
topologySpreadConstraints: []
# - maxSkew: 1
#   topologyKey: topology.kubernetes.io/zone
#   whenUnsatisfiable: ScheduleAnyway
#   labelSelector:
#     matchLabels:
#       app.kubernetes.io/name: language-operator

# Pod labels
podLabels: {}

# Service labels
serviceLabels: {}

# Persona Library configuration
personaLibrary:
  # Enable persona library ConfigMaps
  enabled: true
  # List of built-in personas to install
  personas:
    - financial-analyst
    - devops-engineer
    - general-assistant
    - executive-assistant
    - customer-support
