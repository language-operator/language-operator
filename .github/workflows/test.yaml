name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Lint and validate code
  lint:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run go fmt
        working-directory: kubernetes/language-operator
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        working-directory: kubernetes/language-operator
        run: go vet ./...

  # Run unit tests
  unit-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run tests
        working-directory: kubernetes/language-operator
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage summary
        working-directory: kubernetes/language-operator
        run: |
          go tool cover -func=coverage.out | tail -1

  # Validate CRD manifests
  validate-manifests:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Install controller-gen
        working-directory: kubernetes/language-operator
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

      - name: Generate manifests
        working-directory: kubernetes/language-operator
        run: |
          $(go env GOPATH)/bin/controller-gen rbac:roleName=manager-role crd:allowDangerousTypes=true webhook paths="./..." output:crd:artifacts:config=config/crd/bases

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Generated manifests are out of date. Run 'make manifests' and commit the changes." && exit 1)

  # Test web tool
  web-tool-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: https://github.com/actions/checkout@v4

      - name: Set up Ruby
        uses: https://github.com/ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
        env:
          BUNDLE_GIT__THERYANS__IO: ${{ secrets.REGISTRY_TOKEN }}

      - name: Install dependencies
        working-directory: tools/web
        run: bundle install
        env:
          BUNDLE_GIT__THERYANS__IO: ${{ secrets.REGISTRY_TOKEN }}

      - name: Run tests
        working-directory: tools/web
        run: bundle exec rspec --format documentation

  # Test email tool
  email-tool-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: https://github.com/actions/checkout@v4

      - name: Set up Ruby
        uses: https://github.com/ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
        env:
          BUNDLE_GIT__THERYANS__IO: ${{ secrets.REGISTRY_TOKEN }}

      - name: Install dependencies
        working-directory: tools/email
        run: bundle install
        env:
          BUNDLE_GIT__THERYANS__IO: ${{ secrets.REGISTRY_TOKEN }}

      - name: Run tests
        working-directory: tools/email
        run: bundle exec rspec --format documentation

