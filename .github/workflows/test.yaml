name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Lint and validate code
  lint:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'src/go.mod'
          cache-dependency-path: 'src/go.sum'

      - name: Run go fmt
        working-directory: src
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        working-directory: src
        run: go vet ./...

  # Run unit tests
  unit-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'src/go.mod'
          cache-dependency-path: 'src/go.sum'

      - name: Set up Ruby
        uses: https://github.com/ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: false

      - name: Install language-operator gem
        run: |
          mkdir -p ~/.gem
          cat > ~/.gem/credentials << EOF
          ---
          https://git.theryans.io/api/packages/language-operator/rubygems: Bearer ${{ secrets.REGISTRY_TOKEN }}
          EOF
          chmod 0600 ~/.gem/credentials
          gem install language-operator --source https://git.theryans.io/api/packages/language-operator/rubygems

      - name: Run tests
        working-directory: src
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage summary
        working-directory: src
        run: |
          go tool cover -func=coverage.out | tail -1

  # Validate CRD manifests
  validate-manifests:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'src/go.mod'
          cache-dependency-path: 'src/go.sum'

      - name: Install controller-gen
        working-directory: src
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

      - name: Generate manifests
        working-directory: src
        run: |
          $(go env GOPATH)/bin/controller-gen rbac:roleName=manager-role crd:allowDangerousTypes=true webhook paths="./..." output:crd:artifacts:config=config/crd/bases

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Generated manifests are out of date. Run 'make manifests' and commit the changes." && exit 1)

  # Run end-to-end integration tests
  e2e-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'src/go.mod'
          cache-dependency-path: 'src/go.sum'

      - name: Install envtest assets
        working-directory: test/e2e
        run: |
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          echo "KUBEBUILDER_ASSETS=$($(go env GOPATH)/bin/setup-envtest use -p path)" >> $GITHUB_ENV

      - name: Run e2e tests
        working-directory: test/e2e
        run: |
          go test -v -timeout 10m ./...
