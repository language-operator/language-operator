name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Lint and validate code
  lint:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run go fmt
        working-directory: kubernetes/language-operator
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        working-directory: kubernetes/language-operator
        run: go vet ./...

  # Run unit tests
  unit-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run tests
        working-directory: kubernetes/language-operator
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage summary
        working-directory: kubernetes/language-operator
        run: |
          go tool cover -func=coverage.out | tail -1

  # Validate CRD manifests
  validate-manifests:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Install controller-gen
        working-directory: kubernetes/language-operator
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

      - name: Generate manifests
        working-directory: kubernetes/language-operator
        run: |
          $(go env GOPATH)/bin/controller-gen rbac:roleName=manager-role crd:allowDangerousTypes=true webhook paths="./..." output:crd:artifacts:config=config/crd/bases

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Generated manifests are out of date. Run 'make manifests' and commit the changes." && exit 1)

  # Test web tool
  web-tool-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run web tool tests in Docker
        run: |
          docker rm -f web-test 2>/dev/null || true
          docker run -d --name web-test git.theryans.io/language-operator/base:latest sleep 300
          docker cp tools/web web-test:/app
          docker exec --user root web-test sh -c 'chown -R langop:langop /app'
          docker exec --user langop web-test sh -c '
            cd /app &&
            bundle install &&
            bundle exec rspec --format documentation
          '
          docker rm -f web-test

  # Test email tool
  email-tool-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run email tool tests in Docker
        run: |
          docker rm -f email-test 2>/dev/null || true
          docker run -d --name email-test git.theryans.io/language-operator/base:latest sleep 300
          docker cp tools/email email-test:/app
          docker exec --user root email-test sh -c 'chown -R langop:langop /app'
          docker exec --user langop email-test sh -c '
            cd /app &&
            bundle install &&
            bundle exec rspec --format documentation
          '
          docker rm -f email-test

