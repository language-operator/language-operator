name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Lint and validate code
  lint:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run go fmt
        working-directory: kubernetes/language-operator
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Run go vet
        working-directory: kubernetes/language-operator
        run: go vet ./...

  # Run unit tests
  unit-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Run tests
        working-directory: kubernetes/language-operator
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Display coverage summary
        working-directory: kubernetes/language-operator
        run: |
          go tool cover -func=coverage.out | tail -1

  # Validate CRD manifests
  validate-manifests:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'kubernetes/language-operator/go.mod'
          cache-dependency-path: 'kubernetes/language-operator/go.sum'

      - name: Install controller-gen
        working-directory: kubernetes/language-operator
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0

      - name: Generate manifests
        working-directory: kubernetes/language-operator
        run: |
          $(go env GOPATH)/bin/controller-gen rbac:roleName=manager-role crd:allowDangerousTypes=true webhook paths="./..." output:crd:artifacts:config=config/crd/bases

      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Generated manifests are out of date. Run 'make manifests' and commit the changes." && exit 1)

  # Test Ruby SDK
  ruby-sdk-test:
    runs-on: builder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SDK tests in Docker
        run: |
          # Volume mounts don't work in CI, so copy files into container
          docker rm -f ruby-test 2>/dev/null || true

          docker run -d --name ruby-test ruby:3.4-alpine sleep 300
          docker cp sdk/ruby ruby-test:/app
          docker exec ruby-test sh -c '
            cd /app &&
            apk add --no-cache build-base git &&
            gem build language-operator.gemspec &&
            gem install language-operator-0.1.0.gem &&
            bundle install &&
            bundle exec rspec
          '
          docker rm -f ruby-test

  # Test web tool
  web-tool-test:
    runs-on: builder
    needs: [ruby-sdk-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: git.theryans.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build SDK gem
        run: |
          docker rm -f gem-builder 2>/dev/null || true
          cat > /tmp/build-gem.sh << 'EOF'
          #!/bin/sh
          set -e
          cd /build
          apk add --no-cache git
          gem build language-operator.gemspec
          EOF
          chmod +x /tmp/build-gem.sh
          docker run -d --name gem-builder ruby:3.4-alpine sleep 300
          docker cp sdk/ruby gem-builder:/build
          docker cp /tmp/build-gem.sh gem-builder:/build-gem.sh
          docker exec gem-builder /build-gem.sh
          docker cp gem-builder:/build/language-operator-0.1.0.gem sdk/ruby/
          docker rm -f gem-builder
          cp sdk/ruby/language-operator-0.1.0.gem components/ruby/

      - name: Build base image
        working-directory: components/base
        run: docker build -t git.theryans.io/langop/base:latest .

      - name: Build ruby image
        working-directory: components/ruby
        run: docker build -t git.theryans.io/langop/ruby:latest .

      - name: Build tool component image
        working-directory: components/tool
        run: docker build -t git.theryans.io/langop/tool:latest .

      - name: Build web tool image
        working-directory: tools/web
        run: docker build -t git.theryans.io/langop/web-tool:latest .

      - name: Run web tool unit tests
        working-directory: tools/web
        run: |
          # Volume mounts don't work in CI, so copy files into container
          docker rm -f web-test 2>/dev/null || true
          docker run -d --name web-test git.theryans.io/langop/web-tool:latest sleep 300
          docker cp . web-test:/tmp/workspace
          docker exec --user root web-test chown -R langop:langop /tmp/workspace
          docker exec -w /tmp/workspace web-test sh -c "bundle config set --local path 'vendor/bundle' && bundle install && bundle exec rspec --format documentation"
          docker rm -f web-test

  # Test email tool
  email-tool-test:
    runs-on: builder
    needs: [ruby-sdk-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: git.theryans.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build SDK gem
        run: |
          docker rm -f gem-builder 2>/dev/null || true
          cat > /tmp/build-gem.sh << 'EOF'
          #!/bin/sh
          set -e
          cd /build
          apk add --no-cache git
          gem build language-operator.gemspec
          EOF
          chmod +x /tmp/build-gem.sh
          docker run -d --name gem-builder ruby:3.4-alpine sleep 300
          docker cp sdk/ruby gem-builder:/build
          docker cp /tmp/build-gem.sh gem-builder:/build-gem.sh
          docker exec gem-builder /build-gem.sh
          docker cp gem-builder:/build/language-operator-0.1.0.gem sdk/ruby/
          docker rm -f gem-builder
          cp sdk/ruby/language-operator-0.1.0.gem components/ruby/

      - name: Build base image
        working-directory: components/base
        run: docker build -t git.theryans.io/langop/base:latest .

      - name: Build ruby image
        working-directory: components/ruby
        run: docker build -t git.theryans.io/langop/ruby:latest .

      - name: Build tool component image
        working-directory: components/tool
        run: docker build -t git.theryans.io/langop/tool:latest .

      - name: Build email tool image
        working-directory: tools/email
        run: docker build -t git.theryans.io/langop/email-tool:latest .

      - name: Run email tool unit tests
        working-directory: tools/email
        run: |
          # Volume mounts don't work in CI, so copy files into container
          docker rm -f email-test 2>/dev/null || true
          docker run -d --name email-test git.theryans.io/langop/email-tool:latest sleep 300
          docker cp . email-test:/tmp/workspace
          docker exec --user root email-test chown -R langop:langop /tmp/workspace
          docker exec -w /tmp/workspace email-test sh -c "bundle config set --local path 'vendor/bundle' && bundle install && bundle exec rspec --format documentation"
          docker rm -f email-test
