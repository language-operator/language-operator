apiVersion: langop.io/v1alpha1
kind: LanguageCluster
metadata:
  name: demo-cluster
spec:
  # Optional: Custom namespace name (will be auto-generated if not specified)
  namespace: demo-cluster-ns

  # Network configuration
  # PREREQUISITE: Cilium must be installed before creating a LanguageCluster
  # Install Cilium using one of these methods:
  #
  # Option 1: Using cilium CLI
  #   cilium install --version 1.15.0
  #
  # Option 2: Using Helm
  #   helm repo add cilium https://helm.cilium.io/
  #   helm install cilium cilium/cilium --version 1.15.0 --namespace kube-system
  #
  # Option 3: Using manifests
  #   kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.15.0/install/kubernetes/quick-install.yaml
  network:
    cilium:
      version: "1.18.2"  # For documentation/verification purposes

  # Security groups define network isolation boundaries
  groups:
    # Agents group - for autonomous AI agents
    - name: agents
      description: Autonomous agents that interact with tools and external APIs
      ingress:
        # Allow tools to call agents
        - description: Accept requests from tools
          from:
            group: tools
          ports:
            - protocol: TCP
              port: 8080
      egress:
        # Agents can call tools
        - description: Call tool services
          to:
            group: tools
          ports:
            - protocol: TCP
              port: 8080
        # Agents can access OpenAI API
        - description: Access OpenAI API
          to:
            dns:
              - "api.openai.com"
          ports:
            - protocol: TCP
              port: 443
        # Agents can access Anthropic API
        - description: Access Anthropic API
          to:
            dns:
              - "api.anthropic.com"
          ports:
            - protocol: TCP
              port: 443
        # Allow DNS resolution
        - description: DNS resolution
          to:
            cidr: "0.0.0.0/0"
          ports:
            - protocol: UDP
              port: 53

    # Tools group - for MCP tools/functions
    - name: tools
      description: MCP tools that agents can invoke
      ingress:
        # Allow agents to call tools
        - description: Accept requests from agents
          from:
            group: agents
          ports:
            - protocol: TCP
              port: 8080
        # Allow clients to call tools directly
        - description: Accept requests from clients
          from:
            group: clients
          ports:
            - protocol: TCP
              port: 8080
      egress:
        # Tools can access external APIs (example: GitHub, databases, etc.)
        - description: Access GitHub API
          to:
            dns:
              - "api.github.com"
          ports:
            - protocol: TCP
              port: 443
        # Allow wildcard for Google services
        - description: Access Google APIs
          to:
            dns:
              - "*.googleapis.com"
          ports:
            - protocol: TCP
              port: 443
        # Allow DNS resolution
        - description: DNS resolution
          to:
            cidr: "0.0.0.0/0"
          ports:
            - protocol: UDP
              port: 53

    # Clients group - for user-facing applications
    - name: clients
      description: User-facing chat interfaces and applications
      ingress:
        # Allow external traffic (from outside the cluster)
        - description: Accept external requests
          from:
            cidr: "0.0.0.0/0"
          ports:
            - protocol: TCP
              port: 8080
            - protocol: TCP
              port: 443
      egress:
        # Clients can call agents
        - description: Call agent services
          to:
            group: agents
          ports:
            - protocol: TCP
              port: 8080
        # Clients can call tools
        - description: Call tool services
          to:
            group: tools
          ports:
            - protocol: TCP
              port: 8080
        # Allow DNS resolution
        - description: DNS resolution
          to:
            cidr: "0.0.0.0/0"
          ports:
            - protocol: UDP
              port: 53

    # Ungrouped resources - for resources without explicit group assignment
    # Note: The "default" group name is reserved by the operator
    - name: ungrouped
      description: Minimal isolation for resources without explicit group assignment
      egress:
        # Only allow DNS - minimal permissions
        - description: DNS resolution only
          to:
            cidr: "0.0.0.0/0"
          ports:
            - protocol: UDP
              port: 53
