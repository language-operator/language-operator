# Cilium Direct Replacement Configuration
# This replaces Flannel entirely with Cilium using the same pod CIDR
#
# Based on: https://docs.cilium.io/en/latest/installation/k3s/

cluster:
  name: home

# Operator configuration
operator:
  replicas: 1
  # Add Prometheus annotations to operator
  prometheus:
    enabled: true
    port: 9963

# Use native routing mode (required for NixOS compatibility)
routingMode: native

# Enable auto direct node routes
autoDirectNodeRoutes: true

# Native routing CIDR
ipv4NativeRoutingCIDR: "10.42.0.0/16"

# Install CNI configuration (we're the only CNI now)
cni:
  chainingMode: none
  exclusive: true
  install: true

# IPAM configuration - use the same CIDR as Flannel had
ipam:
  mode: "kubernetes"

# Enable network policies
policyEnforcementMode: "default"

# K3s-specific settings
# Set k8sServiceHost so Cilium AND app pods can reach API server directly
# bypassing the broken ClusterIP routing
k8sServiceHost: 192.168.68.136
k8sServicePort: 6443

# Enable kube-proxy replacement - use Cilium for service routing
# Disable socket-level LB and rely only on eBPF datapath (tc/XDP)
kubeProxyReplacement: "true"
socketLB:
  enabled: false

# CRITICAL: Enable service proxy for API server access from pods
enableK8sEndpointSlice: true

# Enable host reachability to pod IPs (required for health probes)
hostFirewall:
  enabled: false

# Enable host services to allow kubelet to reach pod IPs
enableHostPort: true
hostServices:
  enabled: true
  protocols: tcp,udp

# Enable BPF masquerading (NOT iptables) to properly handle node IP masquerading
# iptables masquerading exempts node IPs, causing pods->API server to fail
bpf:
  masquerade: true
  lbExternalClusterIP: true

# Enable IPv4 masquerading feature (will use BPF because bpf.masquerade=true)
enableIPv4Masquerade: true
enableIPv6Masquerade: false

# Enable Hubble for network observability
hubble:
  enabled: true

  # Hubble Relay - exposes gRPC API for Hubble clients
  relay:
    enabled: true
    # Enable Prometheus metrics for relay with scrape annotations
    prometheus:
      enabled: true
      port: 9966

  # Hubble UI - Web interface
  ui:
    enabled: true

  # Enable Hubble metrics
  # See: https://docs.cilium.io/en/stable/observability/metrics/#hubble-metrics
  metrics:
    enabled:
      - dns:query;ignoreAAAA
      - drop
      - tcp
      - flow
      - icmp
      - http
    # Port for metrics endpoint
    port: 9965
    # Enable OpenMetrics format
    enableOpenMetrics: true

# Enable Prometheus metrics for cilium-agent
# See: https://docs.cilium.io/en/stable/observability/metrics/
prometheus:
  enabled: true
  port: 9962
  # Specific metrics to enable
  metrics:
    - "+cilium_forward_count_total"
    - "+cilium_forward_bytes_total"
    - "+cilium_drop_count_total"
    - "+cilium_drop_bytes_total"
    - "+cilium_policy_*"
    - "+cilium_endpoint_*"
    - "+cilium_datapath_*"
    - "+cilium_bpf_*"
